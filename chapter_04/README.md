## 4.1 在判断文件类型的程序中，替换 stat 为 lstat，若命令行参数之一是符号链接，会发生什么变化

当文件参数是符号链接时，`lstat` 返回符号链接本身的有关信息，而不是符号链接引用的文件的信息

因此替换后，该程序不再会输出「符号链接类型」的结果，另外若符号链接引用的文件不存在，则程序出错

## 4.2 若 umask 屏蔽字是 777，结果会怎样？

将关闭文件的所有访问权限

## 4.3 关闭用户拥有的文件的读权限，将导致用户无法访问自己的文件

## 4.4 创建文件 foo 和 bar 后，调用创建它们的相关程序，结果如何？

文件的权限位不会变化，但文件内容被截断

## 4.5 普通文件大小可为 0，那么目录和符号链接的长度可否为 0？

目录总是包含 `.`、`..` 两项，因此其文件大小不可能为 0

符号链接的长度指其路径名所包含的字符数，因此也不可能为 0

## 4.6 编写一个类似 cp(1) 的程序，它复制包含空洞的文件时，不会将字节 0 写到输出文件中

## 4.7 假设 umask 没有变化，为什么新创建的 core 和使用重定向复制的 core.copy 的权限不一样

```bash
-rw-r--r-- core
-rw-rw-r-- core.copy
```

内核对新创建的文件有一个默认权限，在这里为 644，其可能会也可能不会被 umask 影响

重定向创建的文件默认权限为 666，且其会被 umask 影响

## 4.8 在观察一个打开文件并调用 unlink 的程序时，为什么使用 df 检查空闲的磁盘空间，而不是 du？

因为在打开文件后执行 `unlink`，文件的内容不会马上删除，但其目录项会被删除

而 `du` 命令需要目录名或文件名，况且，`du` 命令并无计算仍然在被占用的磁盘空间

## 4.9 unlink 函数会修改文件状态更改时间，这是怎么发生的？

若被删除的链接不是文件的最后一个链接，则更新链接计数，此时文件状态更改时间变化

若被删除的链接是最后一个链接，则文件会被物理删除，此时 inode 被释放，更新时间的行为无意义

## 4.10 myftw 是一个统计指定目录下的所有文件类型的数量的程序，若系统对可打开的文件数有限制，则会产生什么影响？

因为其递归调用子函数实现目录树内各文件类型总数的统计，限制文件描述符数量将会限制目录树的递归深度

## 4.11 使用 chdir 重写 myftw，比较运行时间

## 4.12 每个进程都有一个根目录用于解析绝对路径，可以通过 chroot 改变根目录，什么时候会应用这个函数？

- 在 FTP 中辅助安全性，将匿名用户放在一个单独的目录，将其作为对应的根目录，可以阻止用户访问该目录外的文件
- 构造文件系统层次结构的副本，测试新软件包的安装

该函数只能由超级用户执行，一旦更改了一个进程的根，该进程及其子进程就不能再恢复原来的根

## 4.13 如何只设置两个时间值中的一个来使用 utimes 函数？

`utimes` 函数接收一个路径参数，和一个包含访问时间戳和修改时间戳的数组指针

若只想修改一个时间，则可先调用 `stat` 取得文件的三个时间值

## 4.14 finger 邮箱程序是如何确定新邮件到达时间和阅读时间的？

调用 `stat` 函数，最近修改时间即上次接收时间，最近访问时间即上次读邮件时间

## 4.15 cpio 和 tar 档案文件的 3 个可能的时间值中，哪几个是为每个文件保存的？文件复原时，文件的访问时间是？

其存储的只是归档文件的修改时间

- 因为归档时肯定需要读文件，每个文件的访问时间即为归档文件的创建时间，因此没有存储访问时间
- 对于状态修改时间，`utimes` 系列函数不能更改它，因此在归档和抽取时也不能修改它，因此也没有存储状态修改时间

对于文件复原：

- `tar` 默认复原归档时的修改时间，访问时间为抽取文件时的时间
- `cpio` 默认将修改时间和访问时间设置为抽取文件时的时间

## 4.16 UNIX 系统对目录树深度有无限制？试着编写程序循环创建目录，并使叶结点的路径名长度大于系统的 PATH_MAX，此时能调用 getcwd 吗？UNIX 系统工具如何处理长路径名？可以使用 tar 或 cpio 归档递归目录吗？

对深度无限制，但如果路径名超出最大长度，则有许多命令会出错

在不同系统的具体表现不同，但大部分都不能调用 `getcwd` 或进行归档

## 4.17 有些程序创建输出文件时，会先删除文件以保障文件名不存在，但需要有对应路径的写权限，否则 unlink 失败